<!DOCTYPE html>
<!--
TODO:
 one-time deposit / withdrawal
 clear mod if its the same as the base element (i.e. check & uncheck useAsCash current still leaves the mod there)
 highlight things with mods

 total and +/- on summaries!
 fix mod remove button placement
 cash out investments etc.
 chart overlay going off the chart on left
 store state in cookie
 fix date modifications: mod reordering!!!
  
 use snackbar for link copy?
-->
<html>
<head>
  <title>Financial Life Simulator</title>
  <meta charset = "utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script src="https://code.getmdl.io/1.3.0/material.min.js"></script> <!-- TODO DEFER!! -->
<!--  <script src="d3.v4.min.js"></script> -->
  
  <style>
    body {
      background-color: #FAFAFA;
    }
	
	* {
	  font-family: 'Roboto', sans-serif;
	}

	#chartContainer {
      margin-top: 1em;
	  padding-left: 1em;
	  padding-right: 1em;
	  position: sticky;
	  top: 0px;
	  z-index: 5;
	  background-color: #FAFAFA;
	}

	#chart {
	  width: 100%;
	  height: 15em;
	}
	
	#mouseTimeLine {
	  stroke:#000000;
	  stroke-width:2;
	}
	
	.modLine {
	  stroke:#000000;
	  stroke-width:2;
	}
	
	#mouseBreakdown {
	}
	
	.axis {
	  font-size: 0.8em;
	}

	.portfolioHeader {
	  background-color: #5C6BC0;
	  color: #FFFFFF;
	  padding-top: 0.5em;
	  padding-bottom: 0.5em;
	  position: relative;
	}
	
	.portfolioExpand {
	  position: absolute;
	  bottom: 5px;
	  right: 5px;
	}
	
	.portfolio {
	  float: left;
	  margin-top: 5px;
	  margin-left: 5px;
	  margin-right: 5px;
	  margin-bottom: 5px;
	  border-style: solid;
	  border-width: thin;
	  background-color: #F5F5F5;
	  width: 100%;
	}
	
	summary {
	  font-size: 1.2em;
	}
	
	.container {
	  background-color: darkgreen;
	  padding: 2px;
	}
	
	.outerContainer {
	  border-left-style: solid;
	  border-width: 2px;
	/*  background-color: #03A9F4; */
	  padding-top: 2px;
	  padding-bottom: 2px;
	  padding-left: 2px;
	  padding-right: 2px;
	  margin-bottom: 5px;
	}
	
	.incomesContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.incomesOuterContainer {
	}
	
	.expensesContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.expensesOuterContainer {
	}
	
	.investmentsContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.investmentsOuterContainer {
	}
	
	.debtsContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.debtsOuterContainer {
	}
	
	.incomes {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.expenses {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.investments {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.debts {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.modName {
	  font-weight: bold;
	}
	
	input[type=text]:focus {
	  background-color: #FFF176;
	}
	
	input[type=date]:focus {
	  background-color: #FFF176;
	}
	
	input[type=button] {
      background-color: #FBC02D;
      border: none;
      color: white;
      padding: 2px 2px;
      text-decoration: none;
      margin: 2px 2px;
      cursor: pointer;
	}
	
	#portfolioTemplate {
	  display: none;
	}
	
	#url {
	  background-color: #757575;
	  font-size: 0.8em;
	}
  </style>
</head>

<body onresize="init(); refresh()">


<div class="mdl-layout mdl-js-layout">

	<div style="position: absolute; top: 5px; right: 25px; z-index: 5; display: block">
	  <div class="mdl-textfield mdl-js-textfield" id="shareUrl" style="opacity: 0; width: 1px">
	  <input class="mdl-textfield__input" type="text" id="url" onfocusout="hideUrl()" style="padding: 0px">
       </div> <!-- TODO FIX THIS ON MOBILE! -->

<button id="shareButton" onclick="urlClick()" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored">
  <i class="material-icons"><!--link-->share</i>
</button>
<div class="mdl-tooltip" data-mdl-for="shareButton">
Copy shareable link
</div>
</div>

  <header class="mdl-layout__header mdl-layout__header--scroll">
    <div class="mdl-layout__header-row">
      <!-- Title -->
      <span class="mdl-layout-title">Financial life simulator</span>
      <!-- Add spacer, to align navigation to the right -->
      <div class="mdl-layout-spacer"></div>
	  

      
    </div>
  </header>
  <main class="mdl-layout__content">
    <div class="page-content">

<div id="chartContainer">
<svg id="chart">
<g id="mainChart"></g>
<g id="chartOverlays">
<line x1="0" y1="0" x2="200" y2="200" style="display:none" id="mouseTimeLine"></line>
<text x="0" y="0" style="display:none" id="mouseBreakdown">
<tspan id="mouseBreakdownDate" x="0" dy="0"></tspan>
<tspan id="mouseBreakdownTotal" x="0" dy="1.4em"></tspan>
</text>
</g>
<g id="chartMods"></g>
</svg>
</div>

<!--
<div class="mdl-grid">
  <div class="mdl-cell mdl-cell--4-col">
  <details><summary>summary1</summary>
  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--4-col">
	  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
        <input class="mdl-textfield__input" type="text" id="1">
        <label class="mdl-textfield__label" for="1">Cash</label>
      </div>
    </div>
    <div class="mdl-cell mdl-cell--4-col">
	  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
        <input class="mdl-textfield__input" type="text" id="1">
        <label class="mdl-textfield__label" for="1">Cash</label>
      </div>
    </div>

  </details>
  </div>
  <div class="mdl-cell mdl-cell--4-col">
  <details><summary>summary2</summary>
  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--2-col"></div>
    <div class="mdl-cell mdl-cell--2-col"></div>
   </div>

  </details>
  </div>
</div>
-->


<div class="mdl-grid" id="portfolioGrid">
  <div class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet  mdl-cell--6-col-phone" id="initialContainer"></div>
</div>


<div class="mods"></div>

<input type="button" id="addNewMod" value="Add new life event" onclick="addNewMod()">
<input type="date" id="changeEndDate" value="2030-01-01" oninput="changeEndDate()">
	
	</div>
  </main>
</div>

<select id="interestSelect" style="display: none">
  <option value="yearly">yearly</option>
  <option value="monthly">monthly</option>
</select>

<!-- <svg width="500" height="100"><g class="slider"></g></svg> -->

<!--
<div id="addExpense" style="position:absolute; top:200px; left:200px; z-index:9; display:none">
<p><input type="text" value="name" id="addExpenseName"></p>
<p><input type="text" value="123" id="addExpenseMonthly"></p>
<input type="button" value="add" id="addExpenseAdd" onclick="addExpense()">
</div>
-->


<div class="breakdown" style="display: none">
<div class="date"></div>
<div class="cash"></div>
</div>

<div id="portfolioTemplate" class="portfolio">
  <div class="portfolioHeader">
    <div class="modName mdl-textfield" style="width: 60%">
	  <input type="text" class="mdl-textfield__input" style="vertical-align: top; width: 100%" value="Starting portfolio" disabled>
	</div>
	<button class="portfolioExpand mdl-button" onclick="onPortfolioExpand(this)">
      <i class="material-icons">expand_less</i>
    </button>
	<!-- TODO ADD START DATE -->
  </div>
  <div class="portfolioBody">
    <div class="cashContainer">
	  <div class="mdl-textfield">
        <input class="mdl-textfield__input" type="text" id="initialCash">
        <label class="mdl-textfield__label" for="initialCash">Cash</label>
      </div>
	</div>
    <div class="incomesOuterContainer outerContainer"><details><summary><span>Incomes</span></summary><div class="incomesContainer"></div><button class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored newIncome" onclick="addNewIncome(this)"><i class="material-icons">add</i></button></details></div>
    <div class="expensesOuterContainer outerContainer"><details><summary><span>Expenses</span></summary><div class="expensesContainer"></div><button class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored newExpense" onclick="addNewExpense(this)"><i class="material-icons">add</i></button></details></div>
    <div class="investmentsOuterContainer outerContainer"><details><summary><span>Investments</span></summary><div class="investmentsContainer"></div><button class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored newInvestment" onclick="addNewInvestment(this)"><i class="material-icons">add</i></button></details></div>
    <div class="debtsOuterContainer outerContainer"><details><summary><span>Debts</span></summary><div class="debtsContainer"></div><button class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored newDebt" onclick="addNewDebt(this)"><i class="material-icons">add</i></button></details></div>
  </div>
</div>


<!--
<form name="new_investment" onSubmit="newInvestment()">
            <input type="text" id="name" placeholder="Name"><br>
            <input type="initial" id="initial" placeholder="Initial value"><br>
            <input type="monthly +/-" id="monthly" placeholder="Monthly +/0"><br>
            <input type="monthly rate" id="rate" placeholder="Monthly rate"><br>
            <input name="Submit"  type="submit" value="Add" >
</form>
-->

<script defer type="text/javascript">

max = function(a,b) { return a > b ? a : b; }
min = function(a,b) { return a < b ? a : b; }
roundToCents = function(x) { return Math.floor(x*100)/100.0; }

setUpInitialPortfolio = function() {
  d3.select("#initialContainer").append(() => d3.select("#portfolioTemplate").node().cloneNode(true)).attr("id", "initial");
  <!-- TODO WHY DONT THESE NEED UPGRADE?! IS MDL INIT AFTER THESE ARE FILLED IN? -->
  d3.select("#initial").select(".portfolioHeader").select(".mdl-textfield").attr("class", "modName mdl-textfield mdl-js-textfield");
  d3.select("#initial").select(".portfolioBody").select(".mdl-textfield").attr("class", "mdl-textfield mdl-js-textfield mdl-textfield--floating-label");
  d3.select("#initial").select(".mdl-button").attr("class", "portfolioExpand mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab").nodes().forEach(x => componentHandler.upgradeElement(x));
}
setUpInitialPortfolio();

mouseX = 0;
mouseY = 0;

onPortfolioExpand = function(e) {
  var state = d3.select(e).select("i").text();
  if (state == "expand_more") {
    d3.select(e).select("i").text("expand_less");
	d3.select(ancestor(e,2)).select(".portfolioBody").attr("style", null);
  } else {
    d3.select(e).select("i").text("expand_more");
	d3.select(ancestor(e,2)).select(".portfolioBody").attr("style", "display: none");
  }
}

changeEndDate = function() {
  var dateInputValue = d3.select("#changeEndDate").node().value.split("-");
  var y,m,d;
  [y,m,d] = dateInputValue;
  if (isNaN(y) || isNaN(m) || isNaN(d)) return;
  var date = new Date(y,m-1,d);
  end = date;
  init();
  refresh();
}

nextId = function() {
  var maxId = 0;
  var p = portfolios[0][1];
  var kinds = ["incomes", "expenses", "investments", "debts"];
  for (var a in kinds) {
	for (var x in p[kinds[a]]) {
	  var id = Number(x);
	  if (id > maxId) maxId = id;
	}
  }
  kinds = ["new_income", "new_expense", "new_investment", "new_debt"];
  for (var mi in mods) {
    var m = mods[mi];
    for (var a in kinds) {
	  for (var x in m[1][kinds[a]]) {
	    var id = Number(m[1][kinds[a]][x].id);
	    if (id > maxId) maxId = id;
	  }
	}
  }
  return maxId+1;
}

addExpense = function(i) {
  var addExpenseDiv = d3.select("#addExpense");
  mods[i][1].new_expense.push({
    id: nextId(),
	expense: {
      name: addExpenseDiv.select("#addExpenseName").property("value"),
      monthly: Number(addExpenseDiv.select("#addExpenseMonthly").property("value")),
      start: 0,
      interest: 0,
	},
  });
  addExpenseDiv.style("display", "none");
  
  validPortfoliosEnd = 1;
  fillModsTable();
  refreshChart();
}

addNewIncome = function(elem) {
  portfolios[0][1].incomes[nextId()] = {
    name: "new income",
    monthly: 1000,
    start: 0,
    interest: 0,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewExpense = function(elem) {
  portfolios[0][1].expenses[nextId()] = {
    name: "new expense",
    monthly: 1000,
    start: 0,
    interest: 0,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewInvestment = function(elem) {
  portfolios[0][1].investments[nextId()] = {
    name: "new investment",
    monthly: 0,
    start: 1000,
    interest: 0.01/12,
	useAsCash: false,
	funding: 0,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewDebt = function(elem) {
  portfolios[0][1].debts[nextId()] = {
    name: "new debt",
    monthly: 0,
    start: 1000,
    interest: 0.01/12,
	useAsCash: false,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewIncomeMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_income.push({id: nextId(), income: {
    name: "new income",
    monthly: 1000,
    start: 0,
    interest: 0,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

addNewExpenseMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_expense.push({id: nextId(), expense: {
    name: "new expense",
    monthly: 1000,
    start: 0,
    interest: 0,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

addNewInvestmentMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_investment.push({id: nextId(), investment: {
    name: "new investment",
    monthly: 1000,
    start: 0,
    interest: 0.01/12,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

addNewDebtMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_debt.push({id: nextId(), debt: {
    name: "new debt",
    monthly: 1000,
    start: 0,
    interest: 0.01/12,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

newExpenseDialog = function(i) {
  var div = d3.select("#addExpense");
  div.style("display", "inline").style("top", mouseY + "px").style("left", mouseX+"px");
  div.select("#addExpenseAdd").attr("onclick", "addExpense("+i+")");
}

values = function(investment, from, to) {
  var ret = [{date: new Date(from), value: investment.start}];
  for (var i = new Date(from); i < to; i.setMonth(i.getMonth()+1)) {
    var prev = ret[ret.length-1];
    ret.push({date: new Date(i), value: prev.value + prev.value*investment.interest + investment.monthly});
  }
  return ret;
}

initSlider0 = function(slider) {
  var width = 400;
  var height = 10;
  slider.attr("transform", "translate(10, 10)");
  slider.append("rect").attr("width", width).attr("height", height).attr("style", "stroke:rgb(0,0,0);stroke-width:2;fill:rgb(255,255,255)");
}

// elem is a svg g
initSlider = function(slider, begin, end, values, callback) {
  var width = 400;
  var height = 10;
  var xScale = d3.scaleLinear().domain([begin, end]).range([0, width]);
  sums = [values[0][1]];
  for (var i=1; i < values.length; i++) {
    sums.push(sums[i-1]+values[i][1]);
  }
  var fillers = slider.selectAll(".filler").data(values);
  var newFillers = fillers
      .enter()
          .append("rect")
              .attr("y", 2)
              .attr("height", height-4)
              .attr("class", "filler");
  var allFillers = newFillers.merge(fillers);
  allFillers
      .attr("x", (d,i) => xScale(i == 0 ? 0 : sums[i-1]))
      .attr("width", d => xScale(d[1]))
      .attr("style", d => "fill:" + colors[d[0]])
  fillers.exit().remove();

  var markers = slider.selectAll(".marker").data(sums)
      .enter()
          .append("circle")
              .attr("cx", d => xScale(d))
              .attr("cy", height/2)
              .attr("r", 10)
              .attr("class", "marker")
              .call(d3.drag().on("drag", function(d, i) { 
                var newValue = xScale.invert(d3.event.x);
                var delta = newValue - sums[i];
                var markers = d3.select(this.parentNode).selectAll(".marker");
                for (var j = i; j < sums.length; j++) {
                  sums[j] += delta;
                }
				values[0][1] = sums[0];
				for (var i = 1; i < sums.length; i++) {
				  values[i][1] = sums[i] - sums[i-1];
				}
                markers.data(sums).attr("cx", d => xScale(d));
				slider.selectAll(".filler").data(values).attr("x", (d,i) => xScale(i == 0 ? 0 : sums[i-1]))
                    .attr("width", d => xScale(d[1]));
				callback();
        	  }))
      .exit().remove();
}

stacked = true;

start = new Date(2018, 0, 1);
end = new Date(2030, 0, 1);

chartXPadding = 10;
chartYPadding = 10;

init = function() {
var boundingRect = d3.select("#chart").node().getBoundingClientRect();
yScale = d3.scaleLinear()
      .domain([80000.0, 5000000.0])
      .range([boundingRect.height-chartYPadding, 0]);
xScale = d3.scaleTime()
        .domain([start, end])
        .range([chartXPadding, boundingRect.width]);
}
init();

total = function(portfolio) {
  var t = portfolio.cash;
  for (var id in portfolio.investments) {
    t += portfolio.investments[id].start;
  }
  for (var id in portfolio.debts) {
    t -= portfolio.debts[id].start;
  }
  return t;
};
formatTotal = function(t) {
  t = ""+Math.floor(t);
  var start = t.length % 3;
  if (start == 0) start = 3;
  var ret = t.slice(0, start);
  for (var idx = start; idx < t.length; idx += 3) {
    ret = ret + "," + t.slice(idx, idx+3);
  }
  return ret;
};
mouseMove = function() {
  var x = d3.mouse(this)[0];
//  var y = d3.mouse(this)[1];
  var time = xScale.invert(x);
  d3.select("#chart").select("#mouseTimeLine")
      .attr("x1", x)
      .attr("x2", x)
      .attr("y1", 0)
      .attr("y1", yScale.range()[1])
	  .attr("style", "");
  d3.select("#chart").select("#mouseBreakdown")
      .attr("transform", "translate("+(x+5)+", 50)")
	  .attr("style", "");
    d3.select("#chart").select("#mouseBreakdown").select("#mouseBreakdownDate").text(dateToString(time));
    d3.select("#chart").select("#mouseBreakdown").select("#mouseBreakdownTotal").text("Total: " + formatTotal(total(getPortfolio(time)[1])));

//  fillBreakdown(xScale.invert(x))
};
bodyMouseMove = function() {
  mouseX = d3.mouse(this)[0];
  mouseY = d3.mouse(this)[1];
}
d3.select("body").on("mousemove", bodyMouseMove);
d3.select("#chart").on("mousemove", mouseMove);

//colors = ["green", "red", "blue", "orange", "yellow", "purple", "pink", "black", "aqua", "teal", "brown"];
colors = ["#FFE0B2", "#FFB74D", "#FF9800", "#F57C00", "#E65100", "#BF360C"];

investments = {};
nextIdTmp = 1;

investments[nextIdTmp++] = {
  name: "dummy investment",
  start: 100000.0,
  interest: 0.04/12,
  monthly: 1000.0,
  funding: 0,
};

portfolio = {
  cash: 100000,
  investments: investments,
  debts:{},
  incomes: {},
  expenses: {},
};

portfolio.incomes[nextIdTmp++] = {
  name: "dummy income",
  monthly: 5000,
  start: 0,
  interest: 0,
};
portfolio.expenses[nextIdTmp++] = {
  name: "dummy expense",
  monthly: 2000,
  start: 0,
  interest: 0,
};

portfolios = [[start, portfolio]];

getId = function(name, portfolio) {
  for (var p in portfolio) {
    for (var id in portfolio[p]) {
      if (portfolio[p][id].name == name) return id;
	}
  }
}

mods = [];

current_version = 3;

createURLParam = function() {
  var json = JSON.stringify([current_version,portfolios[0],mods]);
  return btoa(json);
}
createURL = function() {
  return window.location.origin + window.location.pathname + "?data=" + createURLParam();
}
const dateFormat = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/;
parseDate = function(key, value) {
    if (typeof value === "string" && dateFormat.test(value)) {
        return new Date(value);
    }
    return value;
}
parse = function(version, data) {
  if (version == 0) {
    var oldPortfolios = data[0];
	var oldMods = data[1];
	for (var mod in oldMods) {
	  mod[1].name = "unnamed life event";
	}
	parse(1, [1, oldPortfolios, oldMods]);
  } else if (version == 1) {
    var oldPortfolios = data[1];
	var oldMods = data[2];
	for (var idx in oldMods) {
	  oldMods[idx][1].disabled = false;
	}
	parse(2, [2, oldPortfolios, oldMods]);
  } else if (version == 2) {
    var oldPortfolios = data[1];
	var oldMods = data[2];
	for (var i in oldPortfolios[1].investments) {
	  oldPortfolios[1].investments[i].funding = 0;
	}
	parse(3, [3, oldPortfolios, oldMods]);
  } else if (version == current_version) {
    portfolios = [data[1]];
	mods = data[2];
  }
}
initFromURLParam = function() {
  var params = new URLSearchParams(window.location.search);
  var encoded = params.get("data");
  if (encoded != null) {
    var data = JSON.parse(atob(encoded), parseDate);
	var version;
	if (data.length == 0) {
	  version = 0;
	} else {
	  version = data[0];
	}
	parse(version, data);
  }
}
initFromURLParam();
urlClick = function() {
  d3.select("#url").attr("value", createURL());
  d3.select("#shareUrl").attr("style", "");
  d3.select("#url").node().focus();
  d3.select("#url").node().select();
  document.execCommand('copy');
}
hideUrl = function() {
  d3.select("#shareUrl").attr("style", "opacity: 0; width: 1px");
}

applyMod = function(portfolio, mod) {
  if (mod.disabled) return;
  mod.change_income.map(x => { Object.assign(portfolio.incomes[x.id], x.income); portfolio.incomes[x.id].hasMod = true; } );
  mod.change_expense.map(x => { Object.assign(portfolio.expenses[x.id], x.expense); portfolio.expenses[x.id].hasMod = true; });
  mod.change_investment.map(x => { Object.assign(portfolio.investments[x.id], x.investment); portfolio.investments[x.id].hasMod = true; });
  mod.change_debt.map(x => { Object.assign(portfolio.debts[x.id], x.debt); portfolio.debts[x.id].hasMod = true; });
  mod.new_expense.map(x => { portfolio.expenses[x.id] = x.expense; portfolio.expenses[x.id].isNew = true; });
  mod.new_income.map(x => { portfolio.incomes[x.id] = x.income; portfolio.incomes[x.id].isNew = true; });
  mod.new_investment.map(x => { portfolio.investments[x.id] = x.investment; portfolio.investments[x.id].isNew = true; });
  mod.new_debt.map(x => { portfolio.debts[x.id] = x.debt; portfolio.debts[x.id].isNew = true; });
}

// returns overall monthly +/-
balance = function(portfolio) {
  var ret = 0;
  for (var id in portfolio["investments"]) {
    if (portfolio["investments"][id].useAsCash) continue;
	var m = portfolio["investments"][id].monthly;
	if (m < 0 && -m > portfolio["investments"][id].start) m = -portfolio["investments"][id].start;
    ret -= m;	
  }
  for (var id in portfolio["expenses"]) {
    ret -= portfolio["expenses"][id].monthly;
  }
  for (var id in portfolio["debts"]) {
    if (portfolio["debts"][id].useAsCash) continue;
	var m = portfolio["debts"][id].monthly;
	if (m < 0 && -m > portfolio["debts"][id].start) m = -portfolio["debts"][id].start;
    ret -= m;	
  }
  for (var id in portfolio["incomes"]) {
    ret += portfolio["incomes"][id].monthly;
  }
  return ret;
}

fillNextPortfolio = function(portfolio, nextPortfolio) {
  var copy = function(x) {
    var c = {};
	for (var id in x) {
      c[id] = Object.assign({}, x[id]);
	  c[id].isNew = false;
	  c[id].hasMod = false;
	};
	return c;
  }
  var b = balance(portfolio);
  var next = nextPortfolio;
  Object.assign(next, {
    cash: portfolio.cash,
    investments: copy(portfolio.investments),
    debts: copy(portfolio.debts),
    incomes: copy(portfolio.incomes),
    expenses: copy(portfolio.expenses),
  });
  var update = function(x) {
    if ('useAsCash' in x && x.useAsCash) {
	  x.start = x.start + x.start * x.interest;
	  var withdrawal = max(min(-b, x.start), 0);
	  x.start -= withdrawal;
	  b += withdrawal;
	} else {
      x.start = max(0, x.start + x.start * x.interest + x.monthly + ('funding' in x ? x.funding : 0));
	}
	x.start = roundToCents(x.start);
  };
  for (var p in next) {
    for (var id in next[p]) {
	  update(next[p][id]);
	}
  }
  next.cash += b;
  return next;
}

validPortfoliosEnd = 1;

fillPortfolios = function(until) {
  var last = portfolios[validPortfoliosEnd-1];
  var nextMonth = function(date) {
    date.setMonth(date.getMonth()+1);
    return date;
  }
  var mods_idx = 0;
  for (var date = nextMonth(new Date(last[0])); date <= until; nextMonth(date)) {
    last = portfolios[validPortfoliosEnd-1];
    for (; mods_idx < mods.length && mods[mods_idx][0] < last[0]; mods_idx++) {}
    if (validPortfoliosEnd == portfolios.length) {
	  portfolios.push([new Date(date), {}]);
	}
	fillNextPortfolio(portfolios[validPortfoliosEnd-1][1], portfolios[validPortfoliosEnd][1]);
	var next = nextMonth(new Date(date));
	for (; mods_idx < mods.length && mods[mods_idx][0] < next; mods_idx++) {
	  applyMod(portfolios[validPortfoliosEnd][1], mods[mods_idx][1]);
	}
	validPortfoliosEnd++;
  }
}
fillPortfolios(end);

getPortfolio = function(date) {
  fillPortfolios(date);
  for (var i = 0; i < portfolios.length - 1; i++) {
    if (portfolios[i][0] <= date && portfolios[i+1][0] > date) {
      return portfolios[i];
    }
  }
  return portfolios[portfolios.length-1];
}

clearPortfoliosAfter = function(date) {
  var idx = 0;
  for (; idx < portfolios.length; idx++) {
    if (portfolios[idx][0] > date) {
	  break;
	}
  }
  if (idx > 1) idx--;
  validPortfoliosEnd = idx;
}

dateToString = function(d) {
 return "" + d.getFullYear() + "/" + (d.getMonth()+1) + "/" + d.getDate()
}

fillBreakdown = function(date) {
  d3.select(".breakdown").select(".date").text(dateToString(date));
  var portfolio = getPortfolio(date)[1];
  var values = [["total", 0], ["cash", portfolio.cash]];
  var total = portfolio.cash;
  for (var id in portfolio.investments) {
    total = total + portfolio.investments[id].start;
    values.push([portfolio.investments[id].name, portfolio.investments[id].start]);
  }
  values[0][1] = total;
  // TODO: cash, debts
  var breakdownValues = d3.select(".breakdown").selectAll(".breakdownValue").data(values);
  breakdownValues.text(d => d[0] + ": " + Math.round(d[1]));
  breakdownValues.enter().append("div").attr("class", "breakdownValue");
  breakdownValues.exit().remove();
}

refresh = function () {
  console.log("refreshing");
  refreshChart();
  fillInitialTable();
//  fillInitialSlider();
  fillModsTable();
};

removeModsForId = function(id) {
  var modKinds = ["change_income", "change_expense", "change_investment", "change_debt"];
  for (var i = 0; i < mods.length; i++) {
    for (var j = 0; j < modKinds.length; j++) {
	  var to_remove = [];
      for (var k = 0; k < mods[i][1][modKinds[j]].length; k++) {
  	    if (mods[i][1][modKinds[j]][k].id == id) {
		  to_remove.push(k);
  	    }
      }
      for (var k = to_remove.length - 1; k >= 0; k--) {	  
	     mods[i][1][modKinds[j]].splice(to_remove[k], 1);
      }
    }
  }
}

fillInitialTable = function() {
  var initialPortfolio = d3.select("#initial").select(".portfolioBody");
  initialPortfolio.datum(portfolios[0]);
  portfolioTable(initialPortfolio, x => x, true,
      function(data, kind, id, property, value) {
        data[1][kind][id][property] = value;
        validPortfoliosEnd = 1;
    	refresh();
      },
	  function(data, kind, id) {
	    if (!confirm("Remove " + data[1][kind][id].name + "?")) return;
		delete data[1][kind][id];
		removeModsForId(id);
        validPortfoliosEnd = 1;
		refresh();
	  },
	  () => {}
  );
}

d3.select("#interestSelect").on("input", function() { refresh(); });

ancestor = function(node, n) {
  if (n <= 0) return node;
  return ancestor(node.parentNode, n-1);
}

portfolioTable = function(container, getPortfolioFn, isInitial, propertyCb, deleteCb, undoModsCb) {
  var cashContainer = container.select(".cashContainer");
  var cash = cashContainer.select("input");
  cash.on("input", function() { getPortfolioFn(d3.select(this).datum())[1].cash = Number(this.value); validPortfoliosEnd = 1; refresh(); });
  if (!isInitial) {
    cash.attr("disabled", "");
  }
  cash.attr("value", d => getPortfolioFn(d)[1].cash);
  cash.property("value", d => getPortfolioFn(d)[1].cash);
  
  var isNumeric = function(property) {
    if (property == "name") return false;
	return true;
  };
  var printProperty = function(property, d) {
    if (property == 'monthly' && 'useAsCash' in d[1] && d[1].useAsCash) return "N/A";
    var value = d[1][property];
    if (property == "interest" && d3.select("#interestSelect").node().value == "yearly") {
	  value = value * 12;
	}
	return "" + value;
  };
  var parseProperty = function(property, value) {
    if (isNumeric(property)) value = Number(value);
    if (property == "interest" && d3.select("#interestSelect").node().value == "yearly") {
	  value = value / 12;
	}
	return value;
  };

  var addProperty = function(newContainers, allContainers, property, enabled, cols, colsTablet, colsPhone) {
    var inputClass = "input-" + property;
	var gridDiv = newContainers.append("div")
	    .attr("class", "mdl-cell mdl-cell--" + cols + "-col " + "mdl-cell--" + colsTablet + "-col-tablet mdl-cell--" + colsPhone + "-col-phone");
    var inputDiv = gridDiv.append("div").attr("class", "mdl-textfield mdl-js-textfield mdl-textfield--floating-label");
	var idFn = function(d) { return property + "-" + d[0] + "-" + d3.select(ancestor(this, 8)).attr("data-idx"); };
    var input = inputDiv.append("input")
	    .on("input", function() { propertyCb(d3.select(ancestor(this, 7)).datum(), d3.select(ancestor(this,3)).attr("data-kind"), d3.select(ancestor(this,3)).attr("data-id"), property, parseProperty(property, this.value)); })
		.attr("type", "text")
		.attr("id", idFn)
		.attr("size", property == 'name' ? "20" : "9")
		.attr("class", inputClass + " mdl-textfield__input");
    inputDiv.append("label").attr("class", "mdl-textfield__label").attr("for", idFn).text(property).nodes().forEach(x => componentHandler.upgradeElement(x));

    var disabled = function(d) {
	  if (property == 'monthly' && 'useAsCash' in d[1] && d[1].useAsCash) return true;
	  if (d[1].isNew || enabled) return false;
	  return true;
	};
	allContainers.select("." + inputClass).merge(input)
		.attr("value", d => printProperty(property, d))
		.property("value", d => printProperty(property, d))
		.attr("disabled", d => disabled(d) ? "" : null);
	inputDiv.nodes().forEach(x => componentHandler.upgradeElement(x) );
  };
  var incomeList = ["incomes", "expenses"];
  for (var idx in incomeList) {
    var kind = incomeList[idx];
    var currentContainer = container.select("."+kind+"Container");
    var incomes = currentContainer.selectAll("." + kind).data(d => Object.entries(getPortfolioFn(d)[1][kind]));
	incomes.exit().remove();
	var newIncomes = incomes.enter().append("div").attr("class", kind + " mdl-grid").attr("data-kind", () => kind).attr("style", "position: relative");
	var buttons = newIncomes.append("div").attr("style", "position: absolute; top: 2px; right: 2px; z-index: 2");
	buttons.append("button")  
		.attr("class", "undoModsButton mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored")
		.on("click", function() { undoModsCb(d3.select(ancestor(this, 6)).datum(), d3.select(ancestor(this,2)).attr("data-kind"), d3.select(ancestor(this,2)).attr("data-id")); })
		.append("i").attr("class", "material-icons").html("undo");
	buttons.append("button")
	    .attr("style", function(d) {
		  var display;
		  if (isInitial || ('isNew' in d[1] && d[1].isNew)) display = "";
		  else display = "; display: none";
		  return "transform: scale(0.8)" + display;
		})
		.attr("class", "mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored")
		.on("click", function() { deleteCb(d3.select(ancestor(this, 6)).datum(), d3.select(ancestor(this,2)).attr("data-kind"), d3.select(ancestor(this,2)).attr("data-id")); })
		.append("i").attr("class", "material-icons").html("delete");
    newIncomes.select(".mdl-button").nodes().forEach(x => componentHandler.upgradeElement(x));
    var allIncomes = newIncomes.merge(incomes);
	allIncomes.select(".undoModsButton").attr("style", function(d) {
	  var display;
      if ('hasMod' in d[1] && d[1].hasMod) display = "";
	  else display = "; display: none";
	  return "transform: scale(0.8)" + display;
	})
	allIncomes.attr("data-id", d => d[0]);
	addProperty(newIncomes, allIncomes, "name", isInitial, 6, 4, 2);
	addProperty(newIncomes, allIncomes, "monthly", true, 6, 4, 2);
  }
  
  var investmentList = ["investments", "debts"];
  for (var idx in investmentList) {
    var kind = investmentList[idx];
    var currentContainer = container.select("."+kind+"Container");
    var investments = currentContainer.selectAll("." + kind).data(d => Object.entries(getPortfolioFn(d)[1][kind]));
	investments.exit().remove();
	var newInvestments = investments.enter().append("div").attr("class", kind + " mdl-grid").attr("data-id", d => d[0]).attr("data-kind", () => kind).attr("style", "position: relative");
	var buttons = newInvestments.append("div").attr("style", "position: absolute; top: 2px; right: 2px; z-index: 2");
	buttons.append("button")  
		.attr("class", "undoModsButton mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored")
		.on("click", function() { undoModsCb(d3.select(ancestor(this, 6)).datum(), d3.select(ancestor(this,2)).attr("data-kind"), d3.select(ancestor(this,2)).attr("data-id")); })
		.append("i").attr("class", "material-icons").html("undo");
	buttons.append("button")
	    .attr("style", function(d) {
		  var display;
		  if (isInitial || ('isNew' in d[1] && d[1].isNew)) display = "";
		  else display = "; display: none";
		  return "transform: scale(0.8)" + display;
		})
		.attr("class", "mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored")
		.on("click", function() { deleteCb(d3.select(ancestor(this, 6)).datum(), d3.select(ancestor(this,2)).attr("data-kind"), d3.select(ancestor(this,2)).attr("data-id")); })
		.append("i").attr("class", "material-icons").html("delete");
    newInvestments.select(".mdl-button").nodes().forEach(x => componentHandler.upgradeElement(x));
    var allInvestments = newInvestments.merge(investments);
	allInvestments.select(".undoModsButton").attr("style", function(d) {
	  var display;
      if ('hasMod' in d[1] && d[1].hasMod) display = "";
	  else display = "; display: none";
	  return "transform: scale(0.8)" + display;
	})
	addProperty(newInvestments, allInvestments, "name", isInitial, 6, 4, 2);
	addProperty(newInvestments, allInvestments, "start", isInitial, 6, 4, 2);
	addProperty(newInvestments, allInvestments, "monthly", true, 6, 4, 2);
	addProperty(newInvestments, allInvestments, "interest", true, 6, 4, 2);

	if (kind == "investments") {
	  addProperty(newInvestments, allInvestments, "funding", true, 6, 4, 2);
    }

	var idFn1 = function(d) { return kind + "-useAsCash-" + d[0] + "-" + d3.select(ancestor(this, 6)).attr("data-idx"); };
	var idFn2 = function(d) { return kind + "-useAsCash-" + d[0] + "-" + d3.select(ancestor(this, 7)).attr("data-idx"); };
    var newCoverExpenses = newInvestments.append("label").attr("style", "height: initial").attr("class", "mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect").attr("for", idFn1);
	newCoverExpenses.append("input")
	    .attr("type", "checkbox")
		.attr("id", idFn2)
		.attr("class", "mdl-checkbox__input coverExpenses")
		.on("click", function() { propertyCb(d3.select(ancestor(this, 6)).datum(), d3.select(ancestor(this,2)).attr("data-kind"), Number(d3.select(ancestor(this,2)).attr("data-id")), "useAsCash", this.checked); });
	newCoverExpenses.append("span").attr("class", "mdl-checkbox__label").text("Cover expenses from this account?");
	newCoverExpenses.nodes().forEach(x => componentHandler.upgradeElement(x));
	allInvestments.select(".coverExpenses").attr("checked", function(d) { d[1].useAsCash ? this.parentNode.MaterialCheckbox.check() : this.parentNode.MaterialCheckbox.uncheck(); return d[1].useAsCash ? "" : null; });
  }
}

fillInitialTable();

getTotalIncome = function(portfolio) {
  var totalIncome = 0;
  for (var id in portfolio.incomes) {
    totalIncome += portfolio.incomes[id].monthly;
  }
  for (var id in portfolio.expenses) {
    totalIncome -= portfolio.expenses[id].monthly;
  }
  for (var id in portfolio.investments) {
    totalIncome += max(0, -portfolio.investments[id].monthly);
  }
  for (var id in portfolio.debts) {
    totalIncome += max(0, portfolio.debts[id].monthly);
  }
  return totalIncome;
}

fillInitialSlider = function() {
  var distribution = [];
  for (var id in portfolios[0][1].investments) {
   distribution.push([id, portfolios[0][1].investments[id].monthly]);
  }
  // TODO debts
  initSlider(d3.select(".slider"), 0, getTotalIncome(portfolios[0][1]), distribution, function() {
    for (var i=0; i < distribution.length; i++) {
	  portfolios[0][1].investments[distribution[i][0]].monthly = distribution[i][1];
	}
	validPortfoliosEnd = 1;
	refresh();
  });
}

initSlider0(d3.select(".slider"));
// fillInitialSlider();

distributionSlider = function() {
  
}

addNewMod = function() {
  var date;
  if (mods.length == 0) {
    date = new Date(start);
  } else {
    date = new Date(mods[mods.length-1][0]);
  }
  date.setFullYear(date.getFullYear()+1);
  var newMod = [date, {
    name: "new life event",
	disabled: false,
    change_income: [],
    change_investment: [],
    new_income: [],
    new_expense: [],
    new_investment: [],
    new_debt: [],
    change_expense: [],
    change_debt: [],
  }];
  
  var idx;
  for (idx = 0; idx < mods.length && mods[idx][0] <= date; idx++) {}
  mods.splice(idx, 0, newMod);
  
  refresh();
}

removeMod = function(idx) {
  if (!confirm("Remove life event?")) return;
  mods.splice(idx, 1);
  if (idx > 0) {
    clearPortfoliosAfter(mods[idx-1][0]);
  } else {
    validPortfoliosEnd = 1;
  }
  refresh();
}

disableMod = function(idx) {
  mods[idx][1].disabled = !mods[idx][1].disabled;
  if (idx > 0) {
    clearPortfoliosAfter(mods[idx-1][0]);
  } else {
    validPortfoliosEnd = 1;
  }
  refresh();
}

yyyyMmDd = function(date) {
  var pad = x => x < 10 ? ("0" + x) : ("" + x);
  return "" + date.getFullYear() + "-" + pad(date.getMonth() + 1) + "-" + pad(date.getDate());
}

fillModsTable = function() {
  var modContainers = d3.select("#portfolioGrid").selectAll(".modPortfolio").select(".portfolio").data(mods);
  modContainers.exit().remove();
  var newModContainers = modContainers.enter().append("div").attr("class", "mdl-cell mdl-cell--3-col modPortfolio  mdl-cell--4-col-tablet  mdl-cell--6-col-phone").append(() => d3.select("#portfolioTemplate").node().cloneNode(true)).attr("id", null);
  newModContainers.select(".newIncome").attr("onclick", "addNewIncomeMod(this)");
  newModContainers.select(".newExpense").attr("onclick", "addNewExpenseMod(this)");
  newModContainers.select(".newInvestment").attr("onclick", "addNewInvestmentMod(this)");
  newModContainers.select(".newDebt").attr("onclick", "addNewDebtMod(this)");
  newModContainers.select(".cashContainer").select("input").attr("id", (d,i) => "initialCash" + i).attr("value", "0");
  newModContainers.select(".cashContainer").select("label").attr("for", (d,i) => "initialCash" + i);
  newModContainers.select(".cashContainer").select(".mdl-textfield").attr("class", "mdl-textfield mdl-js-textfield mdl-textfield--floating-label").nodes().forEach(x => componentHandler.upgradeElement(x));
 
  var newHeaders = newModContainers.select(".portfolioHeader");
  newHeaders.select(".modName").select("input").attr("disabled", null).on("input", function() {
	var mod = d3.select(ancestor(this, 4)).datum();
	mod[1].name = d3.select(this).node().value;
	refresh();
  });
  newHeaders.select(".modName").attr("class", "modName mdl-textfield mdl-js-textfield").nodes().forEach(x => componentHandler.upgradeElement(x));
  newHeaders.select(".mdl-button").attr("class", "portfolioExpand mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab").nodes().forEach(x => componentHandler.upgradeElement(x));

  var headerButtons = newHeaders.append("div").attr("style", "position: absolute; top: 5px; right: 5px");
  headerButtons.append("button").attr("class", "disableMod mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored").attr("style", "float: right").append("i").attr("class", "material-icons").html("power_settings_new");
  headerButtons.append("div").attr("style", "float: right; width: 0.5em; min-height: 1px");
  headerButtons.append("button").attr("class", "removeMod mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored").attr("style", "float: right").append("i").attr("class", "material-icons").html("delete");

  newHeaders.append("div").append("input").attr("type", "date").attr("class", "modDate").on("input", function() {
	  var mod = d3.select(ancestor(this, 3)).datum();
      var dateInputValue = d3.select(this).node().value.split("-");
      var y,m,d;
      [y,m,d] = dateInputValue;
      if (isNaN(y) || isNaN(m) || isNaN(d)) return;
      var date = new Date(y,m-1,d);
	  var min = date < mod[0] ? date : mod[0];
	  mod[0] = date;
	  for (var i = 0; i < mods.length - 1; i++) {
	    if (mods[i][0] > mods[i+1][0]) {
		  this.blur();
		  break;
		}
	  }
	  mods.sort(function(a,b) {
	    if (a[0] < b[0]) return -1;
		if (a[0] > b[0]) return 1;
        return 0;
	  });
	  // TODO prevent going before start
	  clearPortfoliosAfter(min);
	  refresh();
    });
	
  newHeaders.selectAll("button").nodes().forEach(x => componentHandler.upgradeElement(x));
  
  var allModContainers = newModContainers.merge(modContainers);
  allModContainers.attr("style", (d,i) => d[1].disabled ? "opacity: 0.5" : null);
  allModContainers.attr("data-idx", (d,i) => i);
  var allHeaders = allModContainers.select(".portfolioHeader");
  allHeaders.select(".disableMod").attr("onclick", (d,i) => "disableMod("+i+")");
  allHeaders.select(".removeMod").attr("onclick", (d,i) => "removeMod("+i+")");
  allHeaders.select(".modName").select("input").attr("value", d => d[1].name);
  allHeaders.select(".modName").select("input").property("value", d => d[1].name);
  allHeaders.select(".modDate").attr("value", d => yyyyMmDd(d[0]));
  allHeaders.select(".modDate").property("value", d => yyyyMmDd(d[0]));
  portfolioTable(allModContainers.select(".portfolioBody"), d => getPortfolio(d[0]),
    false,
    function(mod, kind, id, property, value) {
	  var modKind;
	  var name;
	  var newModKind;
	  if (kind == "investments") {
	    modKind = "change_investment";
		newModKind = "new_investment";
		name = "investment";
	  } else if (kind == "debts") {
	    modKind = "change_debt";
		newModKind = "new_debt";
		name = "debt";
      } else if (kind == "expenses") {
	    modKind = "change_expense";
		newModKind = "new_expense";
		name = "expense";
	  } else if (kind == "incomes") {
	    modKind = "change_income";
		newModKind = "new_income";
		name = "income";
	  }
	  var changesNewMod = false;
	  for (var idx in mod[1][newModKind]) {
	    if (mod[1][newModKind][idx].id == id) {
		  mod[1][newModKind][idx][name][property] = value;
	      clearPortfoliosAfter(mod[0]);
	      refresh();
		  return;
		}
	  }
	  var found_idx = null;
	  for (var idx in mod[1][modKind]) {
	    if (mod[1][modKind][idx].id == id) {
		  found_idx = idx;
		  break;
		}
	  }
	  if (found_idx == null) {
		found_idx = mod[1][modKind].length;
	    mod[1][modKind].push({ id: id });
	  }
	  if (mod[1][modKind][found_idx][name] === undefined) {
	    mod[1][modKind][found_idx][name] = {};
	  }
	  mod[1][modKind][found_idx][name][property] = value
	  clearPortfoliosAfter(mod[0]);
	  refresh();
    },
    function(mod, kind, id) {
	  var name;
	  var newModKind;
	  if (kind == "investments") {
		newModKind = "new_investment";
		name = "investment";
	  } else if (kind == "debts") {
		newModKind = "new_debt";
		name = "debt";
      } else if (kind == "expenses") {
		newModKind = "new_expense";
		name = "expense";
	  } else if (kind == "incomes") {
		newModKind = "new_income";
		name = "income";
	  }
	  var found_idx = null;
 	  for (var idx in mod[1][newModKind]) {
	    if (mod[1][newModKind][idx].id == id) {
		  found_idx = idx;
		  break;
		}
	  }
	  if (found_idx == null) { console.log("Couldn't find mod with id " + id); return; }
	  if (!confirm("Remove " + mod[1][newModKind][found_idx][name].name + "?")) return;
      mod[1][newModKind].splice(found_idx, 1);
	  clearPortfoliosAfter(mod[0]);
	  removeModsForId(id);
	  refresh();
    },
    function(mod, kind, id) {
	  var name;
	  var changeModKind;
	  if (kind == "investments") {
		changeModKind = "change_investment";
		name = "investment";
	  } else if (kind == "debts") {
		changeModKind = "change_debt";
		name = "debt";
      } else if (kind == "expenses") {
		changeModKind = "change_expense";
		name = "expense";
	  } else if (kind == "incomes") {
		changeModKind = "change_income";
		name = "income";
	  }
	  var found_idx = null;
 	  for (var idx in mod[1][changeModKind]) {
	    if (mod[1][changeModKind][idx].id == id) {
		  found_idx = idx;
		  break;
		}
	  }
	  if (found_idx == null) { console.log("Couldn't find mod for id " + id); return; }
	  if (!confirm("Undo all changes to " + getPortfolio(mod[0])[1][kind][id].name + "?")) return;
	  clearPortfoliosAfter(mod[0]);
      mod[1][changeModKind].splice(found_idx, 1);
	  refresh();
    });
   
   var chartMods = d3.select("#chartMods").selectAll(".chartMod").data(mods);
   chartMods.exit().remove();
   var newChartMods = chartMods.enter().append("g").attr("class", "chartMod");
   yAdj = function(m, i) {
     var adj = -(i%3+1)*2;
	 return adj + "em";
   };
   newChartMods.append("line").attr("x1", 0).attr("x2", 0).attr("y1", 0).attr("y2", yAdj).attr("class", "modLine");
   newChartMods.append("text").attr("x", 0).attr("y", yAdj);
   
   var allChartMods = newChartMods.merge(chartMods);
   allChartMods.attr("style", m => m[1].disabled ? "display:none" : null);
   allChartMods.attr("transform", m => "translate(" + xScale(m[0]) + ", " + yScale(0) + ")");
   allChartMods.select("text").text(m => m[1].name);
}

fillModsTable();

refreshChart = function() {
fillPortfolios(end);
var chart = d3.select("#chart").select("#mainChart");

var lineValuesMap = {};
var maxId = nextId();
for (var i = 0; i < maxId; i++) { lineValuesMap[i] = []; }

var linePointsToRender = 100;
var incMillis = (end.getTime() - start.getTime()) / linePointsToRender;
var datesToRender = [];
for (var millis = start.getTime(); millis < end.getTime(); millis += incMillis) {
  datesToRender.push(new Date(millis));
}
datesToRender.push(new Date(end));
for (var i = 0; i < mods.length; i++) {
  datesToRender.push(new Date(mods[i][0]));
}
datesToRender.sort((a,b) => {
  if (a.getTime() < b.getTime()) {
    return -1;
  } else if (a.getTime() == b.getTime()) {
    return 0;
  } else {
    return 1;
  }
});

datesToRender.forEach(function(d) {
  var p = getPortfolio(d);
  lineValuesMap[0].push({date: p[0], value: p[1].cash});
  for (var i = 1; i < maxId; i++) {
    if (i in p[1].investments) {
	  lineValuesMap[i].push({date: p[0], value: p[1].investments[i].start});
	} else {
	  lineValuesMap[i].push({date: p[0], value: 0});
	}
  }
});

var to_delete = [];
for (var i in lineValuesMap) {
  var empty = true;
  for (var j in lineValuesMap[i]) {
    if (lineValuesMap[i][j].value != 0) {
	  empty = false;
	  break;
	}
  }
  if (empty) {
    to_delete.push(i);
  }
}
to_delete.forEach(i => delete lineValuesMap[i]);
// TODO: debts!! above
var lineValues = Object.entries(lineValuesMap);
// TODO: nice negative values on stacked chart
var minValue = 0.0;
var maxValue = 0.0;
  var stackedValues = [];
  for (var i = 0; i < lineValues.length; i++) {
    var current = [];
    for (var j = 0; j < lineValues[i][1].length; j++) {
	  if (i == 0) {
	    var v = lineValues[i][1][j].value;
	    var bottom = min(v, 0);
		var top = max(v, 0);
	    current.push({date: lineValues[i][1][j].date, value: top, prev: bottom});
	  } else {
	    var v1 = lineValues[i][1][j].value + stackedValues[i-1][j].value;
		var v2 = stackedValues[i-1][j].value;
	    var bottom = min(v1, v2);
		var top = max(v1, v2);
	    current.push({date: lineValues[i][1][j].date, value: top, prev: bottom});
	  }
	}
	stackedValues.push(current);
  }
  for (var i = 0; i < stackedValues.length; i++) {
    for (var j = 0; j < stackedValues[i].length; j++) {
	  minValue = min(minValue, stackedValues[i][j].prev);
	  maxValue = max(maxValue, stackedValues[i][j].value);
	}
  }
  yScale.domain([minValue,maxValue]);
  var areas = chart.selectAll(".area").data(stackedValues);
  var area = d3.area()
	  .x(v => xScale(v.date))
	  .y0(v => yScale(v.prev))
	  .y1(v => yScale(v.value));
  var newAreas = areas.enter().append("path").attr("class", "area").attr("fill", "none").attr("stroke-width", 1);
  var allAreas = newAreas.merge(areas);
  allAreas.attr("d", area).attr("stroke", (d,i) => colors[i]).attr("fill", (d,i) => colors[i]);
  areas.exit().remove();

var xTicks = [];
var yearIncrement = max(Math.floor((end.getFullYear() - start.getFullYear()) / 10), 1);
for (var year = start.getFullYear() + 1; year < end.getFullYear(); year+=yearIncrement) {
  xTicks.push(new Date(year, 0, 1));
}
var yTickDistance = (maxValue - minValue) / 5;
var yTickDistanceRounded = Math.pow(10, Math.round(Math.log(yTickDistance) / Math.log(10)));
var yTickDistanceFinal = yTickDistanceRounded;
if (Math.abs(yTickDistanceFinal / 2.0 - yTickDistance) < Math.abs(yTickDistanceFinal - yTickDistance)) {
   yTickDistanceFinal = yTickDistanceFinal / 2.0;
} else if (Math.abs(yTickDistanceFinal * 5 - yTickDistance) < Math.abs(yTickDistanceFinal - yTickDistance)) {
   yTickDistanceFinal = yTickDistanceFinal * 5;
}
var yTicks = [];
for (var v = minValue + yTickDistanceFinal; v < maxValue; v += yTickDistanceFinal) {
  var t = Math.round(Math.floor(v / yTickDistanceFinal)*yTickDistanceFinal);
  if (t == 0) continue;
  yTicks.push(t);
}
chart.selectAll(".axis").remove();
chart.append("g")
    .attr("class", "axis")
    .attr("transform", "translate("+chartXPadding+",0)")
    .call(d3.axisRight(yScale).tickValues(yTicks).tickSizeOuter(0));
chart.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0,"+(yScale(0))+")")
    .call(d3.axisTop(xScale).tickValues(xTicks));
}

refreshChart();
	
</script>

</body>
</html>