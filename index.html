<!DOCTYPE html>
<html>
<head>
  <title>Financial Life Simulator</title>
  <meta charset = "utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!--  <script src="d3.v4.min.js"></script> -->
  
  <style>
    body {
      background-color: #E1F5FE;
    }
	
	* {
	  font-family: 'Roboto', sans-serif;
	}
	
	#header {
	  margin-bottom: 2em;
	}

    #header span {
      color: black;
      text-align: left;
	  font-size: 2.5em;
	  font-weight: bold; 
    }

    #share {
	  position: absolute;
	  right: 0px;
	  top: 0px;
	  margin: 0.5em;
    }

	.chartContainer {
	  padding-left: 1em;
	  padding-right: 1em;
	}

	.chart {
	  width: 100%;
	  height: 25em;
	}
	
	.axis {
	  font-size: 0.8em;
	}

	.portfolioHeader {
	/*  background-color: yellow; */
	}
	
	.portfolio {
	  float: left;
	  padding: 2px;
	  margin-top: 5px;
	  margin-left: 5px;
	  margin-right: 5px;
	  margin-bottom: 5px;
	  border-style: solid;
	  border-width: thin;
	  background-color: #03A9F4;
	}
	
	.container {
	  background-color: darkgreen;
	  padding: 2px;
	}
	
	.outerContainer {
	  border-left-style: solid;
	  border-width: 2px;
	  background-color: #03A9F4;
	  padding-top: 2px;
	  padding-bottom: 2px;
	  padding-left: 2px;
	  padding-right: 2px;
	  margin-bottom: 5px;
	}
	
	.incomesContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.incomesOuterContainer {
	}
	
	.expensesContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.expensesOuterContainer {
	}
	
	.investmentsContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.investmentsOuterContainer {
	}
	
	.debtsContainer {
	  border-width: thin;
	  margin: 2px;
	}
	
	.debtsOuterContainer {
	}
	
	.incomes {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.expenses {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.investments {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.debts {
	  border-width: thin;
	  border-style: solid;
	  margin: 4px;
	  padding: 2px;
	}
	
	.modName {
	  font-weight: bold;
	}
	
	input[type=text]:focus {
	  background-color: #FFF176;
	}
	
	input[type=date]:focus {
	  background-color: #FFF176;
	}
	
	input[type=button] {
      background-color: #FBC02D;
      border: none;
      color: white;
      padding: 2px 2px;
      text-decoration: none;
      margin: 2px 2px;
      cursor: pointer;
	}
	
	#portfolioTemplate {
	  display: none;
	}
	
	.url {
	}
  </style>
</head>

<body onresize="refresh()">

<div id="header" style="">
<span>Financial life simulator</span>
</div>

<div id="share" style="">
<span class="shareUrl" style="display: none; float: left;">Link copied!
<input class="url" type="text" value="url" onfocusout="hideUrl()">
</span>
<a href="javascript:urlClick()" style="color: inherit"><i class="material-icons md-dark" style="float: left">link</i></a>
</div>

<select id="interestSelect" style="display: none">
  <option value="yearly">yearly</option>
  <option value="monthly">monthly</option>
</select>

<!--
<div id="addExpense" style="position:absolute; top:200px; left:200px; z-index:9; display:none">
<p><input type="text" value="name" id="addExpenseName"></p>
<p><input type="text" value="123" id="addExpenseMonthly"></p>
<input type="button" value="add" id="addExpenseAdd" onclick="addExpense()">
</div>
-->

<div class="chartContainer">
<svg class="chart" onclick="click()"></svg>
</div>

<div class="breakdown">
<div class="date"></div>
<div class="cash"></div>
</div>

<div id="portfolioTemplate" class="portfolio">
  <div class="portfolioHeader"><span>Starting portfolio</span></div>
  <div class="portfolioBody">
    <div class="cashContainer">Cash <input type="text" size=9></div>
    <div class="incomesOuterContainer outerContainer"><details><summary><span>Incomes</span></summary><input type="button" value="[ Add new income ]" class="newIncome" onclick="addNewIncome(this)"><div class="incomesContainer"></div></details></div>
    <div class="expensesOuterContainer outerContainer"><details><summary><span>Expenses</span></summary><input type="button" value="[ Add new expense ]" class="newExpense" onclick="addNewExpense(this)"><div class="expensesContainer"></div></details></div>
    <div class="investmentsOuterContainer outerContainer"><details><summary><span>Investments</span></summary><input type="button" value="[ Add new investment ]" class="newInvestment" onclick="addNewInvestment(this)"><div class="investmentsContainer"></div></details></div>
    <div class="debtsOuterContainer outerContainer"><details><summary><span>Debts</span></summary><input type="button" value="[ Add new debt ]" class="newDebt" onclick="addNewDebt(this)"><div class="debtsContainer"></div></details></div>
  </div>
</div>

<div id="initialContainer"></div>

<!-- <svg width="500" height="100"><g class="slider"></g></svg> -->

<div class="mods"></div>

<input type="button" id="addNewMod" value="Add new life event" onclick="addNewMod()">
<input type="date" id="changeEndDate" value="2030-01-01" oninput="changeEndDate()">

<!--
<form name="new_investment" onSubmit="newInvestment()">
            <input type="text" id="name" placeholder="Name"><br>
            <input type="initial" id="initial" placeholder="Initial value"><br>
            <input type="monthly +/-" id="monthly" placeholder="Monthly +/0"><br>
            <input type="monthly rate" id="rate" placeholder="Monthly rate"><br>
            <input name="Submit"  type="submit" value="Add" >
</form>
-->

<script type="text/javascript">

setUpInitialPortfolio = function() {
  d3.select("#initialContainer").append(() => d3.select("#portfolioTemplate").node().cloneNode(true)).attr("id", "initial");
}
setUpInitialPortfolio();

mouseX = 0;
mouseY = 0;

changeEndDate = function() {
  var dateInputValue = d3.select("#changeEndDate").node().value.split("-");
  var y,m,d;
  [y,m,d] = dateInputValue;
  if (isNaN(y) || isNaN(m) || isNaN(d)) return;
  var date = new Date(y,m-1,d);
  end = date;
  init();
  refresh();
}

nextId = function() {
  var maxId = 0;
  var p = portfolios[0][1];
  var kinds = ["incomes", "expenses", "investments", "debts"];
  for (var a in kinds) {
	for (var x in p[kinds[a]]) {
	  var id = Number(x);
	  if (id > maxId) maxId = id;
	}
  }
  kinds = ["new_income", "new_expense", "new_investment", "new_debt"];
  for (var mi in mods) {
    var m = mods[mi];
    for (var a in kinds) {
	  for (var x in m[1][kinds[a]]) {
	    var id = Number(m[1][kinds[a]][x].id);
	    if (id > maxId) maxId = id;
	  }
	}
  }
  return maxId+1;
}

addExpense = function(i) {
  var addExpenseDiv = d3.select("#addExpense");
  mods[i][1].new_expense.push({
    id: nextId(),
	expense: {
      name: addExpenseDiv.select("#addExpenseName").property("value"),
      monthly: Number(addExpenseDiv.select("#addExpenseMonthly").property("value")),
      start: 0,
      interest: 0,
	},
  });
  addExpenseDiv.style("display", "none");
  
  validPortfoliosEnd = 1;
  fillModsTable();
  refreshChart();
}

addNewIncome = function(elem) {
  portfolios[0][1].incomes[nextId()] = {
    name: "new income",
    monthly: 1000,
    start: 0,
    interest: 0,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewExpense = function(elem) {
  portfolios[0][1].expenses[nextId()] = {
    name: "new expense",
    monthly: 1000,
    start: 0,
    interest: 0,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewInvestment = function(elem) {
  portfolios[0][1].investments[nextId()] = {
    name: "new investment",
    monthly: 0,
    start: 1000,
    interest: 0.01/12,
	useAsCash: false,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewDebt = function(elem) {
  portfolios[0][1].debts[nextId()] = {
    name: "new debt",
    monthly: 0,
    start: 1000,
    interest: 0.01/12,
	useAsCash: false,
  };
  validPortfoliosEnd = 1;
  refresh();
}

addNewIncomeMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_income.push({id: nextId(), income: {
    name: "new income",
    monthly: 1000,
    start: 0,
    interest: 0,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

addNewExpenseMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_expense.push({id: nextId(), expense: {
    name: "new expense",
    monthly: 1000,
    start: 0,
    interest: 0,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

addNewInvestmentMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_investment.push({id: nextId(), investment: {
    name: "new investment",
    monthly: 1000,
    start: 0,
    interest: 0.01/12,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

addNewDebtMod = function(elem) {
  var mod = d3.select(ancestor(elem, 4)).datum();
  mod[1].new_debt.push({id: nextId(), debt: {
    name: "new debt",
    monthly: 1000,
    start: 0,
    interest: 0.01/12,
  }});
  clearPortfoliosAfter(mod[0]);
  refresh();
}

newExpenseDialog = function(i) {
  var div = d3.select("#addExpense");
  div.style("display", "inline").style("top", mouseY + "px").style("left", mouseX+"px");
  div.select("#addExpenseAdd").attr("onclick", "addExpense("+i+")");
}

values = function(investment, from, to) {
  var ret = [{date: new Date(from), value: investment.start}];
  for (var i = new Date(from); i < to; i.setMonth(i.getMonth()+1)) {
    var prev = ret[ret.length-1];
    ret.push({date: new Date(i), value: prev.value + prev.value*investment.interest + investment.monthly});
  }
  return ret;
}

initSlider0 = function(slider) {
  var width = 400;
  var height = 10;
  slider.attr("transform", "translate(10, 10)");
  slider.append("rect").attr("width", width).attr("height", height).attr("style", "stroke:rgb(0,0,0);stroke-width:2;fill:rgb(255,255,255)");
}

// elem is a svg g
initSlider = function(slider, begin, end, values, callback) {
  var width = 400;
  var height = 10;
  var xScale = d3.scaleLinear().domain([begin, end]).range([0, width]);
  sums = [values[0][1]];
  for (var i=1; i < values.length; i++) {
    sums.push(sums[i-1]+values[i][1]);
  }
  var fillers = slider.selectAll(".filler").data(values);
  var newFillers = fillers
      .enter()
          .append("rect")
              .attr("y", 2)
              .attr("height", height-4)
              .attr("class", "filler");
  var allFillers = newFillers.merge(fillers);
  allFillers
      .attr("x", (d,i) => xScale(i == 0 ? 0 : sums[i-1]))
      .attr("width", d => xScale(d[1]))
      .attr("style", d => "fill:" + colors[d[0]])
  fillers.exit().remove();

  var markers = slider.selectAll(".marker").data(sums)
      .enter()
          .append("circle")
              .attr("cx", d => xScale(d))
              .attr("cy", height/2)
              .attr("r", 10)
              .attr("class", "marker")
              .call(d3.drag().on("drag", function(d, i) { 
                var newValue = xScale.invert(d3.event.x);
                var delta = newValue - sums[i];
                var markers = d3.select(this.parentNode).selectAll(".marker");
                for (var j = i; j < sums.length; j++) {
                  sums[j] += delta;
                }
				values[0][1] = sums[0];
				for (var i = 1; i < sums.length; i++) {
				  values[i][1] = sums[i] - sums[i-1];
				}
                markers.data(sums).attr("cx", d => xScale(d));
				slider.selectAll(".filler").data(values).attr("x", (d,i) => xScale(i == 0 ? 0 : sums[i-1]))
                    .attr("width", d => xScale(d[1]));
				callback();
        	  }))
      .exit().remove();
}

stacked = true;

start = new Date(2018, 0, 1);
end = new Date(2030, 0, 1);

chartXPadding = 10;
chartYPadding = 10;

init = function() {
var boundingRect = d3.select(".chart").node().getBoundingClientRect();
yScale = d3.scaleLinear()
      .domain([80000.0, 5000000.0])
      .range([boundingRect.height-chartYPadding, 0]);
xScale = d3.scaleTime()
        .domain([start, end])
        .range([chartXPadding, boundingRect.width]);
}
init();

mouseMove = function() {
  var x = d3.mouse(this)[0]
  fillBreakdown(xScale.invert(x))
}
bodyMouseMove = function() {
  mouseX = d3.mouse(this)[0];
  mouseY = d3.mouse(this)[1];
}
d3.select("body").on("mousemove", bodyMouseMove);
d3.select(".chart").on("mousemove", mouseMove);

//colors = ["green", "red", "blue", "orange", "yellow", "purple", "pink", "black", "aqua", "teal", "brown"];
colors = ["#FFE0B2", "#FFB74D", "#FF9800", "#F57C00", "#E65100", "#BF360C"];

investments = {};
nextIdTmp = 1;

investments[nextIdTmp++] = {
  name: "dummy investment",
  start: 100000.0,
  interest: 0.04/12,
  monthly: 1000.0,
};

portfolio = {
  cash: 100000,
  investments: investments,
  debts:{},
  incomes: {},
  expenses: {},
};

portfolio.incomes[nextIdTmp++] = {
  name: "dummy income",
  monthly: 5000,
  start: 0,
  interest: 0,
};
portfolio.expenses[nextIdTmp++] = {
  name: "dummy expense",
  monthly: 2000,
  start: 0,
  interest: 0,
};

portfolios = [[start, portfolio]];

getId = function(name, portfolio) {
  for (var p in portfolio) {
    for (var id in portfolio[p]) {
      if (portfolio[p][id].name == name) return id;
	}
  }
}

mods = [];

current_version = 2;

createURLParam = function() {
  var json = JSON.stringify([current_version,portfolios[0],mods]);
  return btoa(json);
}
createURL = function() {
  return window.location.origin + window.location.pathname + "?data=" + createURLParam();
}
const dateFormat = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/;
parseDate = function(key, value) {
    if (typeof value === "string" && dateFormat.test(value)) {
        return new Date(value);
    }
    return value;
}
parse = function(version, data) {
  if (version == 0) {
    var oldPortfolios = data[0];
	var oldMods = data[1];
	for (var mod in oldMods) {
	  mod[1].name = "unnamed life event";
	}
	parse(1, [1, oldPortfolios, oldMods]);
  } else if (version == 1) {
    var oldPortfolios = data[1];
	var oldMods = data[2];
	for (var idx in oldMods) {
	  oldMods[idx][1].disabled = false;
	}
	parse(2, [2, oldPortfolios, oldMods]);
  } else if (version == current_version) {
    portfolios = [data[1]];
	mods = data[2];
  }
}
initFromURLParam = function() {
  var params = new URLSearchParams(window.location.search);
  var encoded = params.get("data");
  if (encoded != null) {
    var data = JSON.parse(atob(encoded), parseDate);
	var version;
	if (data.length == 0) {
	  version = 0;
	} else {
	  version = data[0];
	}
	parse(version, data);
  }
}
initFromURLParam();
urlClick = function() {
  d3.select(".url").attr("value", createURL());
  d3.select(".shareUrl").attr("style", "display: inline; float: left;");
  d3.select(".url").node().focus();
  d3.select(".url").node().select();
  document.execCommand('copy');
}
hideUrl = function() {
  d3.select(".shareUrl").attr("style", "display: none; float: left;");
}

applyMod = function(portfolio, mod) {
  if (mod.disabled) return;
  mod.change_income.map(x => Object.assign(portfolio.incomes[x.id], x.income));
  mod.change_expense.map(x => Object.assign(portfolio.expenses[x.id], x.expense));
  mod.change_investment.map(x => Object.assign(portfolio.investments[x.id], x.investment));
  mod.change_debt.map(x => Object.assign(portfolio.debts[x.id], x.debt));
  mod.new_expense.map(x => { portfolio.expenses[x.id] = x.expense; portfolio.expenses[x.id].isNew = true; });
  mod.new_income.map(x => { portfolio.incomes[x.id] = x.income; portfolio.incomes[x.id].isNew = true; });
  mod.new_investment.map(x => { portfolio.investments[x.id] = x.investment; portfolio.investments[x.id].isNew = true; });
  mod.new_debt.map(x => { portfolio.debts[x.id] = x.debt; portfolio.debts[x.id].isNew = true; });
}

// returns overall monthly +/-
balance = function(portfolio) {
  var ret = 0;
  for (var id in portfolio["investments"]) {
    if (portfolio["investments"][id].useAsCash) continue;
    ret -= portfolio["investments"][id].monthly;
  }
  for (var id in portfolio["expenses"]) {
    ret -= portfolio["expenses"][id].monthly;
  }
  for (var id in portfolio["debts"]) {
    if (portfolio["debts"][id].useAsCash) continue;
    ret += portfolio["debts"][id].monthly;
  }
  for (var id in portfolio["incomes"]) {
    ret += portfolio["incomes"][id].monthly;
  }
  return ret;
}

fillNextPortfolio = function(portfolio, nextPortfolio) {
  var copy = function(x) {
    var c = {};
	for (var id in x) {
      c[id] = Object.assign({}, x[id]);
	  c[id].isNew = false;
	};
	return c;
  }
  var b = balance(portfolio);
  var next = nextPortfolio;
  Object.assign(next, {
    cash: portfolio.cash,
    investments: copy(portfolio.investments),
    debts: copy(portfolio.debts),
    incomes: copy(portfolio.incomes),
    expenses: copy(portfolio.expenses),
  });
  var update = function(x) {
    if ('useAsCash' in x && x.useAsCash) {
	  x.start = x.start + x.start * x.interest;
	  var withdrawal = max(min(-b, x.start), 0);
	  x.start -= withdrawal;
	  b += withdrawal;
	} else {
      x.start = x.start + x.start * x.interest + x.monthly;
	}
  };
  for (var p in next) {
    for (var id in next[p]) {
	  update(next[p][id]);
	}
  }
  next.cash += b;
  return next;
}

validPortfoliosEnd = 1;

fillPortfolios = function(until) {
  var last = portfolios[validPortfoliosEnd-1];
  var nextMonth = function(date) {
    date.setMonth(date.getMonth()+1);
    return date;
  }
  var mods_idx = 0;
  for (var date = nextMonth(new Date(last[0])); date <= until; nextMonth(date)) {
    last = portfolios[validPortfoliosEnd-1];
    for (; mods_idx < mods.length && mods[mods_idx][0] < last[0]; mods_idx++) {}
    if (validPortfoliosEnd == portfolios.length) {
	  portfolios.push([new Date(date), {}]);
	}
	fillNextPortfolio(portfolios[validPortfoliosEnd-1][1], portfolios[validPortfoliosEnd][1]);
	var next = nextMonth(new Date(date));
	for (; mods_idx < mods.length && mods[mods_idx][0] < next; mods_idx++) {
	  applyMod(portfolios[validPortfoliosEnd][1], mods[mods_idx][1]);
	}
	validPortfoliosEnd++;
  }
}
fillPortfolios(end);

getPortfolio = function(date) {
  fillPortfolios(date);
  for (var i = 0; i < portfolios.length - 1; i++) {
    if (portfolios[i][0] <= date && portfolios[i+1][0] > date) {
      return portfolios[i];
    }
  }
  return portfolios[portfolios.length-1];
}

clearPortfoliosAfter = function(date) {
  var idx = 0;
  for (; idx < portfolios.length; idx++) {
    if (portfolios[idx][0] > date) {
	  break;
	}
  }
  if (idx > 1) idx--;
  validPortfoliosEnd = idx;
}

dateToString = function(d) {
 return "" + d.getFullYear() + "/" + (d.getMonth()+1) + "/" + d.getDate()
}

fillBreakdown = function(date) {
  d3.select(".breakdown").select(".date").text(dateToString(date));
  var portfolio = getPortfolio(date)[1];
  var values = [["total", 0], ["cash", portfolio.cash]];
  var total = portfolio.cash;
  for (var id in portfolio.investments) {
    total = total + portfolio.investments[id].start;
    values.push([portfolio.investments[id].name, portfolio.investments[id].start]);
  }
  values[0][1] = total;
  // TODO: cash, debts
  var breakdownValues = d3.select(".breakdown").selectAll(".breakdownValue").data(values);
  breakdownValues.text(d => d[0] + ": " + Math.round(d[1]));
  breakdownValues.enter().append("div").attr("class", "breakdownValue");
  breakdownValues.exit().remove();
}

refresh = function () {
  console.log("refreshing");
  refreshChart();
  fillInitialTable();
//  fillInitialSlider();
  fillModsTable();
};

fillInitialTable = function() {
  var initialPortfolio = d3.select("#initial").select(".portfolioBody");
  initialPortfolio.datum(portfolios[0]);
  portfolioTable(initialPortfolio, x => x, true, function(data, kind, id, property, value) {
    data[1][kind][id][property] = value;
    validPortfoliosEnd = 1;
	refresh();
  });
}

d3.select("#interestSelect").on("input", function() { refresh(); });

ancestor = function(node, n) {
  if (n <= 0) return node;
  return ancestor(node.parentNode, n-1);
}

portfolioTable = function(container, getPortfolioFn, isInitial, propertyCb) {
  var cashContainer = container.select(".cashContainer");
  var cash = cashContainer.select("input");
  cash.on("input", function() { getPortfolioFn(d3.select(this).datum())[1].cash = Number(this.value); validPortfoliosEnd = 1; refresh(); });
  if (!isInitial) {
    cash.attr("disabled", "");
  }
  cash.attr("value", d => getPortfolioFn(d)[1].cash);
  cash.property("value", d => getPortfolioFn(d)[1].cash);
  
  var isNumeric = function(property) {
    if (property == "name") return false;
	return true;
  };
  var printProperty = function(property, d) {
    if (property == 'monthly' && 'useAsCash' in d[1] && d[1].useAsCash) return "N/A";
    var value = d[1][property];
    if (property == "interest" && d3.select("#interestSelect").node().value == "yearly") {
	  value = value * 12;
	}
	return "" + value;
  };
  var parseProperty = function(property, value) {
    if (isNumeric(property)) value = Number(value);
    if (property == "interest" && d3.select("#interestSelect").node().value == "yearly") {
	  value = value / 12;
	}
	return value;
  };

  var addProperty = function(newContainers, allContainers, property, enabled) {
    var inputClass = "input-" + property;
	newContainers.append("span").attr("style", "width: 5em; display: inline-block").text(property);
    var input = newContainers.append("input")
	    .on("input", function() { propertyCb(d3.select(ancestor(this, 6)).datum(), d3.select(this.parentNode).attr("data-kind"), d3.select(this.parentNode).attr("data-id"), property, parseProperty(property, this.value)); })
		.attr("type", "text")
		.attr("size", property == 'name' ? "20" : "9")
		.attr("class", inputClass);
    var disabled = function(d) {
	  if (property == 'monthly' && 'useAsCash' in d[1] && d[1].useAsCash) return true;
	  if (d[1].isNew || enabled) return false;
	  return true;
	};
	allContainers.select("." + inputClass).merge(input)
		.attr("value", d => printProperty(property, d))
		.attr("disabled", d => disabled(d) ? "" : null);
  };
  var incomeList = ["incomes", "expenses"];
  for (var idx in incomeList) {
    var kind = incomeList[idx];
    var currentContainer = container.select("."+kind+"Container");
    var incomes = currentContainer.selectAll("." + kind).data(d => Object.entries(getPortfolioFn(d)[1][kind]));
	var newIncomes = incomes.enter().append("div").attr("class", kind);
	var newForms = newIncomes.append("form").attr("data-id", d => d[0]).attr("data-kind", () => kind).attr("style", "float:none");
    var allForms = incomes.select("form").merge(newForms);
	addProperty(newForms, allForms, "name", isInitial);
	newForms.append("br");
	addProperty(newForms, allForms, "monthly", true);
  }
  
  var investmentList = ["investments", "debts"];
  for (var idx in investmentList) {
    var kind = investmentList[idx];
    var currentContainer = container.select("."+kind+"Container");
    var investments = currentContainer.selectAll("." + kind).data(d => Object.entries(getPortfolioFn(d)[1][kind]));
	var newInvestments = investments.enter().append("div").attr("class", kind);
	var newForms = newInvestments.append("form").attr("data-id", d => d[0]).attr("data-kind", () => kind);
    var allForms = investments.select("form").merge(newForms);
	addProperty(newForms, allForms, "name", isInitial);
	newForms.append("br");
	addProperty(newForms, allForms, "start", isInitial);
	newForms.append("br");
	addProperty(newForms, allForms, "monthly", true);
	newForms.append("br");
	addProperty(newForms, allForms, "interest", true);

	// TODO DISABLE MONTHLY IF USEASCASH
	newForms.append("br");
	newForms.append("span").text("Cover expenses from this account?");
	newForms.append("input").attr("type", "checkbox").attr("class", "coverExpenses");
	allForms.select(".coverExpenses").attr("checked", d => d[1].useAsCash ? "" : null).on("click", function() { propertyCb(d3.select(ancestor(this, 6)).datum(), d3.select(this.parentNode).attr("data-kind"), Number(d3.select(this.parentNode).attr("data-id")), "useAsCash", this.checked); });
  }
}

fillInitialTable();

max = function(a,b) { return a > b ? a : b; }
min = function(a,b) { return a < b ? a : b; }

getTotalIncome = function(portfolio) {
  var totalIncome = 0;
  for (var id in portfolio.incomes) {
    totalIncome += portfolio.incomes[id].monthly;
  }
  for (var id in portfolio.expenses) {
    totalIncome -= portfolio.expenses[id].monthly;
  }
  for (var id in portfolio.investments) {
    totalIncome += max(0, -portfolio.investments[id].monthly);
  }
  for (var id in portfolio.debts) {
    totalIncome += max(0, portfolio.debts[id].monthly);
  }
  return totalIncome;
}

fillInitialSlider = function() {
  var distribution = [];
  for (var id in portfolios[0][1].investments) {
   distribution.push([id, portfolios[0][1].investments[id].monthly]);
  }
  // TODO debts
  initSlider(d3.select(".slider"), 0, getTotalIncome(portfolios[0][1]), distribution, function() {
    for (var i=0; i < distribution.length; i++) {
	  portfolios[0][1].investments[distribution[i][0]].monthly = distribution[i][1];
	}
	validPortfoliosEnd = 1;
	refresh();
  });
}

initSlider0(d3.select(".slider"));
// fillInitialSlider();

distributionSlider = function() {
  
}

addNewMod = function() {
  var date;
  if (mods.length == 0) {
    date = new Date(start);
  } else {
    date = new Date(mods[mods.length-1][0]);
  }
  date.setFullYear(date.getFullYear()+1);
  var newMod = [date, {
    name: "new life event",
	disabled: false,
    change_income: [],
    change_investment: [],
    new_income: [],
    new_expense: [],
    new_investment: [],
    new_debt: [],
    change_expense: [],
    change_debt: [],
  }];
  
  var idx;
  for (idx = 0; idx < mods.length && mods[idx][0] <= date; idx++) {}
  mods.splice(idx, 0, newMod);
  
  refresh();
}

removeMod = function(idx) {
  if (!confirm("Remove life event?")) return;
  mods.splice(idx, 1);
  if (idx > 0) {
    clearPortfoliosAfter(mods[idx-1][0]);
  } else {
    validPortfoliosEnd = 1;
  }
  refresh();
}

disableMod = function(idx) {
  mods[idx][1].disabled = !mods[idx][1].disabled;
  if (idx > 0) {
    clearPortfoliosAfter(mods[idx-1][0]);
  } else {
    validPortfoliosEnd = 1;
  }
  refresh();
}

yyyyMmDd = function(date) {
  var pad = x => x < 10 ? ("0" + x) : ("" + x);
  return "" + date.getFullYear() + "-" + pad(date.getMonth() + 1) + "-" + pad(date.getDate());
}

fillModsTable = function() {
  var modContainers = d3.select(".mods").selectAll(".portfolio").data(mods);
  modContainers.exit().remove();
  
  var newModContainers = modContainers.enter().append(() => d3.select("#portfolioTemplate").node().cloneNode(true)).attr("id", null);
  var newHeaders = newModContainers.select(".portfolioHeader");
  newHeaders.select("span").remove();
  var firstHeaderRow = newHeaders.append("div");
  firstHeaderRow.append("input").attr("type", "text").attr("class", "modName").attr("style", "vertical-align: top").on("input", function() {
	var mod = d3.select(ancestor(this, 3)).datum();
	mod[1].name = d3.select(this).node().value;
	refresh();
  });
  firstHeaderRow.append("a").attr("style", "color: inherit; margin: 2px").attr("class", "disableMod").append("i").attr("class", "material-icons md-dark");
  firstHeaderRow.append("a").attr("style", "color: inherit; margin: 2px").attr("class", "removeMod").append("i").attr("class", "material-icons md-dark").html("delete");
  newHeaders.append("div").append("input").attr("type", "date").attr("class", "modDate").on("input", function() {
	  var mod = d3.select(ancestor(this, 3)).datum();
      var dateInputValue = d3.select(this).node().value.split("-");
      var y,m,d;
      [y,m,d] = dateInputValue;
      if (isNaN(y) || isNaN(m) || isNaN(d)) return;
      var date = new Date(y,m-1,d);
	  var min = date < mod[0] ? date : mod[0];
	  mod[0] = date;
	  for (var i = 0; i < mods.length - 1; i++) {
	    if (mods[i][0] > mods[i+1][0]) {
		  this.blur();
		  break;
		}
	  }
	  mods.sort(function(a,b) {
	    if (a[0] < b[0]) return -1;
		if (a[0] > b[0]) return 1;
        return 0;
	  });
	  // TODO prevent going before start
	  clearPortfoliosAfter(min);
	  refresh();
    });
  
  var allModContainers = newModContainers.merge(modContainers);
  allModContainers.attr("style", (d,i) => d[1].disabled ? "opacity: 0.5" : null);
  allModContainers.attr("data-idx", (d,i) => i);
  var allHeaders = allModContainers.select(".portfolioHeader");
  allHeaders.select(".disableMod").attr("href", (d,i) => "javascript:disableMod("+i+")").select("i").html(d => d[1].disabled ? "visibility_off" : "visibility");
  allHeaders.select(".removeMod").attr("href", (d,i) => "javascript:removeMod("+i+")");
  allHeaders.select(".modName").attr("value", d => d[1].name);
  allHeaders.select(".modName").property("value", d => d[1].name);
  allHeaders.select(".modDate").attr("value", d => yyyyMmDd(d[0]));
  allHeaders.select(".modDate").property("value", d => yyyyMmDd(d[0]));
  portfolioTable(allModContainers.select(".portfolioBody"), d => getPortfolio(d[0]),
    false,
    function(mod, kind, id, property, value) {
	  var modKind;
	  var name;
	  var newModKind;
	  if (kind == "investments") {
	    modKind = "change_investment";
		newModKind = "new_investment";
		name = "investment";
	  } else if (kind == "debts") {
	    modKind = "change_debt";
		newModKind = "new_debt";
		name = "debt";
      } else if (kind == "expenses") {
	    modKind = "change_expense";
		newModKind = "new_expense";
		name = "expense";
	  } else if (kind == "incomes") {
	    modKind = "change_income";
		newModKind = "new_income";
		name = "income";
	  }
	  var changesNewMod = false;
	  for (var idx in mod[1][newModKind]) {
	    if (mod[1][newModKind][idx].id == id) {
		  mod[1][newModKind][idx][name][property] = value;
	      clearPortfoliosAfter(mod[0]);
	      refresh();
		  return;
		}
	  }
	  var found_idx = null;
	  for (var idx in mod[1][modKind]) {
	    if (mod[1][modKind][idx].id == id) {
		  found_idx = idx;
		  break;
		}
	  }
	  if (found_idx == null) {
		found_idx = mod[1][modKind].length;
	    mod[1][modKind].push({ id: id });
	  }
	  if (mod[1][modKind][found_idx][name] === undefined) {
	    mod[1][modKind][found_idx][name] = {};
	  }
	  mod[1][modKind][found_idx][name][property] = value
	  clearPortfoliosAfter(mod[0]);
	  refresh();
   });
}

fillModsTable();

refreshInvestment = function(key) {
	investments.set(key, {
		name: d3.select("#name" + key).property("value"),
		start: +d3.select("#start" + key).property("value"),
		monthly: +d3.select("#monthly" + key).property("value"),
		interest: +d3.select("#rate" + key).property("value"),
	});
	stacked = !stacked;
	click();
}

click = function() {
stacked = !stacked;
refreshChart();
}

refreshChart = function() {
fillPortfolios(end);
var chart = d3.select(".chart");
chart.selectAll("*").remove(); // todo fix

var lineValuesMap = {};
var maxId = nextId();
for (var i = 0; i < maxId; i++) { lineValuesMap[i] = []; }
portfolios.forEach(function(p) {
  lineValuesMap[0].push({date: p[0], value: p[1].cash});
  for (var i = 1; i < maxId; i++) {
    if (i in p[1].investments) {
	  lineValuesMap[i].push({date: p[0], value: p[1].investments[i].start});
	} else {
	  lineValuesMap[i].push({date: p[0], value: 0});
	}
  }
});
var to_delete = [];
for (var i in lineValuesMap) {
  var empty = true;
  for (var j in lineValuesMap[i]) {
    if (lineValuesMap[i][j].value != 0) {
	  empty = false;
	  break;
	}
  }
  if (empty) {
    to_delete.push(i);
  }
}
to_delete.forEach(i => delete lineValuesMap[i]);
// TODO: debts!! above
var lineValues = Object.entries(lineValuesMap);
// TODO: nice negative values on stacked chart
var minValue = 0.0;
var maxValue = 0.0;
if (stacked) {
  var stackedValues = [];
  for (var i = 0; i < lineValues.length; i++) {
    var current = [];
    for (var j = 0; j < lineValues[i][1].length; j++) {
	  if (i == 0) {
	    var v = lineValues[i][1][j].value;
	    var bottom = min(v, 0);
		var top = max(v, 0);
	    current.push({date: lineValues[i][1][j].date, value: top, prev: bottom});
	  } else {
	    var v1 = lineValues[i][1][j].value + stackedValues[i-1][j].value;
		var v2 = stackedValues[i-1][j].value;
	    var bottom = min(v1, v2);
		var top = max(v1, v2);
	    current.push({date: lineValues[i][1][j].date, value: top, prev: bottom});
	  }
	}
	stackedValues.push(current);
  }
  for (var i = 0; i < stackedValues.length; i++) {
    for (var j = 0; j < stackedValues[i].length; j++) {
	  minValue = min(minValue, stackedValues[i][j].prev);
	  maxValue = max(maxValue, stackedValues[i][j].value);
	}
  }
  var areas = chart.selectAll(".area").data(stackedValues);
  yScale.domain([minValue,maxValue]);
  var area = d3.area()
	  .x(v => xScale(v.date))
	  .y0(v => yScale(v.prev))
	  .y1(v => yScale(v.value));
  areas.enter().append("path").datum(d => d).attr("d", area).attr("fill", "none").attr("stroke-width", 1).attr("stroke", (d,i) => colors[i]).attr("fill", (d,i) => colors[i]).attr("class", "area");
  areas.exit().remove();
} else {
  var line = d3.line()
	  .x(v => xScale(v.date))
	  .y(v => yScale(v.value));
  var lines = chart.selectAll(".line").data(lineValues);
  lines.enter().append("path").datum(d => d[1]).attr("d", line).attr("fill", "none").attr("stroke-width", 1).attr("stroke", (d,i) => colors[i]);
  lines.exit().remove();
}
var xTicks = [];
for (var year = start.getFullYear() + 1; year < end.getFullYear(); year++) {
  xTicks.push(new Date(year, 0, 1));
}
var yTickDistance = (maxValue - minValue) / 5;
var yTickDistanceRounded = Math.pow(10, Math.round(Math.log(yTickDistance) / Math.log(10)));
var yTickDistanceFinal = yTickDistanceRounded;
if (Math.abs(yTickDistanceFinal / 2.0 - yTickDistance) < Math.abs(yTickDistanceFinal - yTickDistance)) {
   yTickDistanceFinal = yTickDistanceFinal / 2.0;
} else if (Math.abs(yTickDistanceFinal * 5 - yTickDistance) < Math.abs(yTickDistanceFinal - yTickDistance)) {
   yTickDistanceFinal = yTickDistanceFinal * 5;
}
var yTicks = [];
for (var v = minValue + yTickDistanceFinal; v < maxValue; v += yTickDistanceFinal) {
  var t = Math.round(Math.floor(v / yTickDistanceFinal)*yTickDistanceFinal);
  if (t == 0) continue;
  yTicks.push(t);
}
chart.append("g")
    .attr("class", "axis")
    .attr("transform", "translate("+chartXPadding+",0)")
    .call(d3.axisRight(yScale).tickValues(yTicks).tickSizeOuter(0));
chart.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0,"+(yScale(0))+")")
    .call(d3.axisTop(xScale).tickValues(xTicks));
}

refreshChart();
	
</script>

</body>
</html>